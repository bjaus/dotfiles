#!/usr/bin/env zsh
# Fast-loading .zshrc - optimized for speed

# ==================== CURSOR AGENT MODE CHECK ====================
# Use minimal config when running in cursor agent to prevent flickering
if [[ "$AGENT_MODE" = "true" ]] || [[ -n "$CURSOR_AGENT" ]]; then
    # Minimal config for cursor agent - no interactive features
    export PATH="$HOME/.local/bin:$HOME/.scripts:$HOME/scripts:$HOME/Library/pnpm:$HOME/.rd/bin:$PATH"
    export EDITOR="nvim"
    export LANG="en_US.UTF-8"
    
    # Basic git aliases only
    alias g='git'
    alias gs='git status'
    alias ga='git add'
    alias gc='git commit'
    alias gp='git push'
    alias gd='git diff'
    
    # Skip all interactive features
    return
fi

# ==================== CRITICAL PATH OPTIMIZATIONS ====================

# Skip Oh My Zsh's auto-update checks
export DISABLE_AUTO_UPDATE=true
export DISABLE_UPDATE_PROMPT=true

# Minimal Oh My Zsh setup
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="zhann"
plugins=(git)  # Only essential plugins
source $ZSH/oh-my-zsh.sh

# Vi mode
bindkey -v

# ==================== PATH SETUP ====================
export PATH="$HOME/.local/bin:$HOME/.scripts:$HOME/scripts:$HOME/Library/pnpm:$HOME/.rd/bin:$PATH"

# Basic environment
export LANG="en_US.UTF-8"
export EDITOR="${SSH_CONNECTION:+vim}"
export EDITOR="${EDITOR:-nvim}"

# ==================== LAZY LOADING FOR SLOW TOOLS ====================

# Lazy load NVM (biggest performance hit)
export NVM_DIR="$HOME/.nvm"
alias nvm='unalias nvm node npm npx 2>/dev/null; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"; nvm'
alias node='nvm; node'
alias npm='nvm; npm'
alias npx='nvm; npx'

# Lazy load pyenv
export PATH="$HOME/.pyenv/shims:$PATH"
alias pyenv='unalias pyenv 2>/dev/null; eval "$(command pyenv init --path)"; eval "$(command pyenv init -)"; pyenv'

# Lazy load goenv  
export PATH="$HOME/.goenv/shims:$PATH"
alias goenv='unalias goenv 2>/dev/null; eval "$(command goenv init -)"; goenv'

# Lazy load autojump
alias j='unalias j 2>/dev/null; [[ -f /opt/homebrew/etc/profile.d/autojump.sh ]] && . /opt/homebrew/etc/profile.d/autojump.sh; j'

# Lazy load atuin
if [[ -f "$HOME/.config/atuin/config.toml" ]]; then
  alias atuin='unalias atuin 2>/dev/null; source "$HOME/.atuin/bin/env"; eval "$(command atuin init zsh)"; atuin'
fi

# ==================== ALIASES (Fast to load) ====================

# General
alias ca='cursor-agent'
alias cat="bat"
alias cl='claude'
alias clip="tr -d '\n' | pbcopy"
alias nv="nvim"
alias pn="pnpm"
alias rmswp="rm -f /tmp/*.swp"
alias md="glow"

# Git aliases (matching gitconfig)
alias g='git'
alias gs='git s'
alias gss='git ss'
alias gsb='git sb'
alias ga='git a'
alias gaa='git aa'
alias gap='git ap'
alias gc='git c'
alias gca='git ca'
alias gcam='git cam'
alias gcan='git can'
alias gcm='git cm'
alias gp='git ps'
alias gpf='git psf'
alias gpo='git pso'
alias gpoc='git psoc'
alias gpl='git pl'
alias gplo='git plo'
alias gplom='git plom'
alias gf='git f'
alias gfa='git fa'
alias gfo='git fo'
alias gd='git d'
alias gdc='git dc'
alias gds='git ds'
alias gl='git ll'
alias glg='git lg'
alias glp='git lp'
alias gb='git b'
alias gba='git ba'
alias gbd='git bd'
alias gbD='git bdd'
alias gco='git o'
alias gcob='git ob'
alias gcom='git maino'
alias gr='git rb'
alias gra='git rba'
alias grc='git rbc'
alias gri='git rbi'
alias gre='git re'
alias greh='git reh'
alias grehh='git rehh'
alias gst='git sp'
alias gstp='git so'
alias gsta='git sa'
alias gstl='git sl'
alias gsts='git ssp'
alias gcp='git cp'
alias gcpa='git cpa'
alias gcpc='git cpc'
alias gm='git m'
alias gma='git ma'

# Tmux aliases
alias t='tmux'
alias tn='tmux new -s'
alias tl='tmux ls'
alias ta='tmux attach -t'
alias tk='tmux kill-session -t'
alias tka='tmux kill-server'
alias td='tmux detach'
alias ts='tmux switch -t'

# ==================== DEFERRED COMPLETION SETUP ====================
# Load completions in background after shell starts
() {
  setopt LOCAL_OPTIONS NO_NOTIFY NO_MONITOR
  (
    # Wait a moment for shell to be ready
    sleep 0.1
    
    # Setup completion system with caching
    autoload -Uz compinit
    zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
    
    # Check cache age (regenerate daily)
    if [[ $zcompdump -nt /usr/share/zsh ]] && [[ ! $zcompdump.zwc -ot $zcompdump ]]; then
      compinit -C -d "$zcompdump"
    else
      compinit -d "$zcompdump"
      # Compile for faster loading next time
      [[ -f "$zcompdump" && ! -f "$zcompdump.zwc" ]] && zcompile "$zcompdump"
    fi
  ) &!
}

# ==================== OPTIONAL CONFIGS ====================
# Source additional configs if they exist
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"

# Deduplicate PATH
typeset -U path PATH